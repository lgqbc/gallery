<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' https:; style-src 'unsafe-inline' https://cdn.tailwindcss.com; connect-src 'self' https://api.github.com">
  <title>Gallery</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{colors:{coal:"#111111"}}}};</script>

  <style>
    @media (hover: none) {
      .hover\:opacity-100 { opacity: 0.6 !important; }
    }

    @media (pointer: coarse) {
      #prev:hover, #next:hover {
        opacity: 0.25 !important;
      }
      #prev:active, #next:active {
        opacity: 0.4 !important;
      }
    }

    html, body {overflow-x: hidden;}

    #prev img, #next img, #gridBtn img, #openPopup img {
      filter: brightness(0) invert(1);
    }
  </style>
</head>
<body class="bg-coal text-gray-400">

<div id="fullscreen" class="flex items-center justify-center h-screen relative select-none">
  <div id="title" class="hidden absolute bottom-5 left-5 md:left-12 text-2xl"></div>

  <img id="image" class="rounded-md max-w-[100%] 2xl:max-w-[100%] max-h-[100%] 2xl:max-h-[95%] object-contain" src="" alt="">

  <button id="prev" class="text-white opacity-25 hover:opacity-40 active:opacity-40 fixed cursor-pointer z-50 p-0 bg-transparent border-0">
    <img src="icons/prev.svg" alt="Previous" class="w-12 h-12 md:w-20 md:h-20">
  </button>
  <button id="next" class="text-white opacity-25 hover:opacity-40 active:opacity-40 fixed cursor-pointer z-50 p-0 bg-transparent border-0">
    <img src="icons/next.svg" alt="Next" class="w-12 h-12 md:w-20 md:h-20">
  </button>
  
  <button id="gridBtn" class="fixed px-3 py-2 opacity-50 hover:opacity-70 active:opacity-70 z-10">
    <img src="icons/gridBtn.svg" alt="Grid" class="w-12 h-12 md:w-16 md:h-16">
  </button>
  <button id="openPopup" class="fixed px-3 py-2 opacity-50 hover:opacity-70 active:opacity-70 z-10">
    <img src="icons/openPopup.svg" alt="Info" class="w-12 h-12 md:w-16 md:h-16">
  </button>

  <div id="dotsBar" class="fixed flex gap-3 z-10 scale-[60%] md:scale-100"></div>

  <div id="prev-area" class="absolute top-0 left-0 bottom-36 sm:bottom-6 w-1/2 cursor-pointer -z-2"></div>
  <div id="next-area" class="absolute top-0 right-0 bottom-36 sm:bottom-6 w-1/2 cursor-pointer -z-2"></div>
</div>

<div id="grid" class="hidden bg-coal min-h-screen px-5 md:px-12 2xl:px-24 py-5 md:py-12">
   <button id="closeGrid" class="text-4xl sm:text-6xl absolute top-3 right-5 px-2 py-0 text-gray-300 bg-transparent rounded-full opacity-50 hover:opacity-70 z-10 scale-150">Ã—</button>
  <div id="gridContainer" class="grid gap-2 md:gap-5 lg:gap-10 grid-cols-2 lg:grid-cols-3"></div>
</div>

<div id="welcomePopup"
     class="backdrop-blur-md fixed inset-0 bg-coal/50 filter saturate-10 flex items-center justify-center z-50 hidden text-sm sm:text-sm">
  <div class="opacity-50 bg-black text-gray-200 p-3 sm:p-6 rounded-xl max-w-[75%] xl:max-w-[25%] text-justify">
    <h2 class="text-xl text-semibold mb-2">hello.</h2>
    <p class="mb-2 sm:mb-4 italic">you found my gallery. how did you end up here?
      <br><br>all photos are unedited - as shot - on a 2004 digicam.</p>
    <p class="italic text-gray-600">bofu/2026</p>
    <p class="mb-1 italic text-gray-600 text-sm">contact: lukas.gilow@gmail.com</p>
    <br>
    <div class="w-full flex justify-center">
      <button id="closePopup"
              class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:opacity-80">
        Continue
      </button>
    </div>
  </div>
</div>

<script>

// Popup management
const popup = document.getElementById("welcomePopup");
if (!localStorage.getItem("closedPopup")) popup.classList.remove("hidden");

document.getElementById("closePopup").onclick = () => {
  popup.classList.add("hidden");
  localStorage.setItem("closedPopup", "true");
};

document.getElementById("openPopup").onclick = () => popup.classList.remove("hidden");

// State
let images = [], current = 0;

// Image loading
async function loadImages() {
  await new Promise(r => setTimeout(r, 500));
  try {
    const response = await fetch('https://api.github.com/repos/lgqbc/gallery/contents/images');
    const data = await response.json();
    images = data.filter(f => /\.(jpg|jpeg|png|gif|webp)$/i.test(f.name)).map(f => ({
      name: f.name.replace(/\.[^/.]+$/, ''),
      url: f.download_url
    }));
    render();
  } catch (e) {
    document.getElementById('title').textContent = 'Error loading images';
  }
}

// Position UI elements based on image bounds
function positionElements() {
  const img = document.getElementById('image');
  const vw = document.documentElement.clientWidth;
  const vh = document.documentElement.clientHeight;

  // Calculate hypothetical landscape image bounds (3072/2304 ratio)
  const ratio = 3072 / 2304;
  const maxH = vw >= 1536 ? vh * 0.95 : vh;
  let imgW, imgH;

  if (vw / maxH > ratio) {
    imgH = maxH;
    imgW = imgH * ratio;
  } else {
    imgW = vw;
    imgH = imgW / ratio;
  }

  const imgL = (vw - imgW) / 2;
  const leftSpace = imgL;
  const rightSpace = vw - (imgL + imgW);

  // Device detection
  const minDim = Math.min(vw, vh);
  const isMobile = vw < 640 || minDim < 500;
  const isMedium = !isMobile && vw >= 640 && vw < 1024;

  // Helper: position element horizontally (left or right side)
  const positionH = (el, side, space, offset, minSpace = 24, fallback = 12) => {
    const pos = (space >= minSpace ? space / 2 : fallback) + (offset || 0);
    el.style[side] = `${pos}px`;
    el.style[side === 'left' ? 'right' : 'left'] = 'auto';
  };

  // Arrows: vertically center with actual image
  const actualImg = img.getBoundingClientRect();
  const centerY = actualImg.top + actualImg.height / 2;
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');

  prev.style.top = next.style.top = `${centerY}px`;
  prev.style.transform = 'translate(-50%, -50%)';
  next.style.transform = 'translate(50%, -50%)';

  if (isMobile) {
    prev.style.left = '30px';
    next.style.right = '30px';
    next.style.left = 'auto';
  } else {
    const arrowOffset = isMedium ? 15 : 0;
    positionH(prev, 'left', leftSpace, arrowOffset);
    positionH(next, 'right', rightSpace, arrowOffset);
  }

  // Buttons: fixed top, same horizontal logic as arrows
  const gridBtn = document.getElementById('gridBtn');
  const openBtn = document.getElementById('openPopup');
  const btnOffset = (isMobile || isMedium) ? 20 : 0;

  gridBtn.style.top = '24px';
  openBtn.style.top = vw < 768 ? '100px' : '125px';
  gridBtn.style.transform = openBtn.style.transform = 'translateX(50%)';

  if (isMobile) {
    const pos = Math.max(12 + btnOffset, 40);
    gridBtn.style.right = openBtn.style.right = `${pos}px`;
    gridBtn.style.left = openBtn.style.left = 'auto';
  } else {
    const pos = Math.max((rightSpace >= 24 ? rightSpace / 2 : 12) + btnOffset, 40);
    gridBtn.style.right = openBtn.style.right = `${pos}px`;
    gridBtn.style.left = openBtn.style.left = 'auto';
  }

  // Dots: position below or inside image
  const dotsBar = document.getElementById('dotsBar');
  const spaceBelow = vh - actualImg.bottom;
  const dotsY = spaceBelow > 10 ? actualImg.bottom + spaceBelow / 2 : actualImg.bottom - 20;
  const dotsX = actualImg.left + actualImg.width / 2;

  dotsBar.style.top = `${dotsY}px`;
  dotsBar.style.left = `${dotsX}px`;
  dotsBar.style.transform = `translateX(-50%) scale(${isMobile ? 0.6 : 1})`;
}

// Render current state
function render() {
  const fs = document.getElementById('fullscreen');
  const img = document.getElementById('image');
  const isFullscreen = fs.classList.contains('flex');

  img.src = images[current].url;

  if (isFullscreen) {
    // Preload adjacent images
    if (current > 0) new Image().src = images[current - 1].url;
    if (current < images.length - 1) new Image().src = images[current + 1].url;

    // Update UI
    document.getElementById('title').textContent = images[current].name.startsWith("DSC") ? "" : images[current].name;
    document.getElementById('prev').style.display = current === 0 ? 'none' : 'block';
    document.getElementById('next').style.display = current === images.length - 1 ? 'none' : 'block';

    // Position elements after image loads
    const reposition = () => requestAnimationFrame(positionElements);
    img.onload = reposition;
    if (img.complete && img.naturalHeight !== 0) reposition();

    // Update dots
    document.getElementById('dotsBar').innerHTML = images.map((_, i) => {
      const active = i === current;
      return `
        <div class="relative cursor-pointer ${active ? '' : 'group'}" onclick="setCurrent(${i})">
          <div class="absolute inset-[-7px]"></div>
          <div class="w-2 h-2 bg-slate-300 rounded-full ${active ? 'opacity-[1]' : 'opacity-[0.25] group-hover:opacity-[.65]'}"></div>
        </div>
      `;
    }).join('');
  } else {
    // Grid view
    document.getElementById('gridContainer').innerHTML = images.map((img, i) =>
      `<div class="select-none cursor-pointer overflow-hidden aspect-square rounded-lg" onclick="setCurrent(${i})">
         <img src="${img.url}" alt="${img.name}" class="w-full h-full object-cover">
       </div>`
    ).join('');
  }
}

// Navigation helper
function navigate(delta) {
  const next = current + delta;
  if (next >= 0 && next < images.length) {
    current = next;
    render();
  }
}

// Set current image and switch to fullscreen
function setCurrent(i) {
  current = i;
  const fs = document.getElementById('fullscreen');
  fs.classList.remove('hidden');
  fs.classList.add('flex');
  document.getElementById('grid').classList.add('hidden');
  render();
}

// View switching
function toggleView() {
  const fs = document.getElementById('fullscreen');
  const g = document.getElementById('grid');
  const showGrid = g.classList.contains('hidden');

  fs.classList.toggle('hidden', showGrid);
  fs.classList.toggle('flex', !showGrid);
  g.classList.toggle('hidden', !showGrid);
  render();
}

// Event listeners
['prev', 'prev-area'].forEach(id =>
  document.getElementById(id).onclick = () => navigate(-1)
);
['next', 'next-area'].forEach(id =>
  document.getElementById(id).onclick = () => navigate(1)
);
document.getElementById('gridBtn').onclick = toggleView;
document.getElementById('closeGrid').onclick = toggleView;

// Touch gestures
let touchStart = null;

document.getElementById('fullscreen').addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  }
});

document.getElementById('fullscreen').addEventListener('touchmove', e => {
  if (!touchStart) return;
  const dx = e.touches[0].clientX - touchStart.x;
  const dy = e.touches[0].clientY - touchStart.y;

  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 30) {
    navigate(dx < 0 ? 1 : -1);
    touchStart = null;
  }
});

document.getElementById('fullscreen').addEventListener('touchend', () => {
  touchStart = null;
});

// Initialize
loadImages();
window.addEventListener('resize', () => {
  if (document.getElementById('fullscreen').classList.contains('flex')) {
    requestAnimationFrame(positionElements);
  }
});

</script>

</body>
</html>
